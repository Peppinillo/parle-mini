<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0b1020" />
<link rel="manifest" href="manifest.webmanifest" />
<title>Parle+ Mini</title>
<style>
  :root{--bg:#0b1020;--card:#141a2e;--line:#1e2746;--text:#e8eefc;--muted:#9fb3d9;--accent:#7aa2ff}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#10152a);color:var(--text)}
  .wrap{max-width:840px;margin:32px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 8px} p{margin:0 0 14px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px 14px 12px;box-shadow:0 8px 22px rgba(0,0,0,.25);margin-bottom:14px}
  label{font-size:12px;color:var(--muted)} select,button,textarea,input[type='number'],input[type='range']{border-radius:12px;border:1px solid var(--line);background:#0e1430;color:var(--text)}
  select,button{padding:10px 12px;font-weight:600} button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#3f67ff,#2a4de7);border-color:#3a56d9}
  button.ghost{background:transparent}
  .prompt{font-size:18px;line-height:1.4;border:1px dashed var(--line);border-radius:14px;padding:12px;background:#0b1226;margin:8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  textarea{width:100%;min-height:130px;padding:12px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .coach{padding:10px;border-radius:12px;background:#0b1226;border:1px solid #25305a}
  .coach b{color:#cfe0ff}
  .q{margin:6px 0 0 0}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Parle+ Mini</h1>
  <p>Pratique orale du fran√ßais avec un <b>mode Coach</b>. Appuyez sur D√©marrer, parlez librement ; relances automatiques apr√®s un court silence.</p>

  <div class="card">
    <div class="row">
      <label>Niveau</label>
      <select id="level">
        <option value="any">Tous</option>
        <option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option>
      </select>
      <label>Th√®me</label>
      <select id="category">
        <option value="any">Tous</option>
        <option>At home</option><option>Supermarket</option><option>Travel</option>
        <option>Work</option><option>Small talk</option>
      </select>
      <button id="new" class="primary">Nouveau sujet (R)</button>
      <button id="say" class="ghost">üîä Lire</button>
      <span class="hint">Astuce : R = nouveau sujet</span>
    </div>
    <div id="prompt" class="prompt">Cliquez sur ¬´ Nouveau sujet ¬ª pour commencer.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="start" class="primary">D√©marrer (Espace)</button>
      <button id="stop" class="ghost" disabled>Arr√™ter</button>
      <span class="hint" id="status">Reconnaissance vocale : en veille</span>
      <span class="hint" id="timer">00:00</span>
      <div class="spacer"></div>
      <label class="hint">Vitesse de la voix</label>
      <input type="range" id="rate" min="0.7" max="1.3" step="0.05" value="1.0" style="width:160px">
      <button id="repeat" class="ghost">‚Üª R√©p√©ter</button>
      <button id="slow" class="ghost">üê¢ R√©p√©ter lentement</button>
    </div>
    <label style="display:block;margin-top:8px">Transcription en direct (fr-FR)</label>
    <textarea id="text" placeholder="Votre parole s‚Äôaffiche ici‚Ä¶"></textarea>
    <p class="hint">Commandes vocales : ¬´ R√©p√®te ¬ª, ¬´ Plus lentement ¬ª, ¬´ Parle plus doucement ¬ª.</p>
  </div>

  <div class="card">
    <div class="row">
      <label><input type="checkbox" id="coachOn" checked> Mode Coach</label>
      <label>Relance apr√®s silence (s)</label>
      <!-- default set to 10s now -->
      <input type="number" id="silence" min="3" max="15" step="1" value="10" style="width:64px">
      <span class="hint">Le coach posera une nouvelle question ~<b>10 s</b> apr√®s votre arr√™t de parole.</span>
    </div>
    <div id="coach" class="coach">
      <div><b>Assistant :</b> <span id="coachText" class="q">J‚Äô√©noncerai le sujet puis je vous √©couterai.</span></div>
    </div>
  </div>

  <p class="hint">Meilleur support : Chrome/Edge (ordinateur ou Android). Sur Firefox, la reconnaissance vocale n‚Äôest pas disponible.</p>
</div>

<script>
/* =========================
   Parle+ Mini ‚Äî Script FR (Brave Android stable, 10s follow-ups)
   ========================= */

/* --- Banque de sujets (A1 ‚Üí C1) --- */
var PROMPTS = [
  {lvl:'A1', cat:'At home', t:"Pr√©sentez-vous en deux phrases."},
  {lvl:'A1', cat:'Supermarket', t:"Commandez une baguette et un caf√© √† emporter."},
  {lvl:'A1', cat:'Travel', t:"Demandez votre chemin vers un mus√©e proche."},
  {lvl:'A2', cat:'At home', t:"D√©crivez votre matin√©e id√©ale en trois phrases."},
  {lvl:'A2', cat:'Work', t:"Expliquez comment vous organisez votre journ√©e de travail."},
  {lvl:'A2', cat:'Travel', t:"R√©servez une chambre d‚Äôh√¥tel pour deux nuits (dates, heure d‚Äôarriv√©e)."},
  {lvl:'B1', cat:'Work', t:"R√©sumez un projet r√©cent : objectif, obstacles, r√©sultats."},
  {lvl:'B1', cat:'Small talk', t:"Donnez votre avis sur le t√©l√©travail : 2 avantages, 2 risques."},
  {lvl:'B1', cat:'Travel', t:"Expliquez un retard de train et demandez une solution."},
  {lvl:'B2', cat:'Small talk', t:"Discutez d‚Äôune tendance tech et son impact quotidien avec un exemple."},
  {lvl:'B2', cat:'Work', t:"D√©crivez un conflit au travail et sa r√©solution, puis tirez une le√ßon."},
  {lvl:'B2', cat:'Travel', t:"Comparez avion et train pour un trajet moyen (co√ªt, temps, confort)."},
  {lvl:'C1', cat:'Work', t:"Exposez votre vision du t√©l√©travail : compromis viables et limites."},
  {lvl:'C1', cat:'Small talk', t:"Argumentez sur l‚ÄôIA g√©n√©rative dans l‚Äô√©ducation avec nuances."},
  {lvl:'C1', cat:'At home', t:"D√©fendez ou critiquez le minimalisme domestique avec un exemple concret."}
];

/* --- Templates de relance --- */
var TEMPLATES = {
  generic: {
    easy: ["Pouvez-vous donner un exemple ?","Pourquoi ? Donnez une raison simple.","Qui ? O√π ? Quand ?","Ajoutez une phrase de plus, s'il vous pla√Æt."],
    hard: ["Nuancez votre r√©ponse avec un contre-argument.","Donnez un exemple pr√©cis et une donn√©e chiffr√©e.","Quelles seraient les cons√©quences √† moyen terme ?","Que proposeriez-vous comme am√©lioration concr√®te ?"]
  },
  'At home': {
    easy: ["Quelles trois choses voyez-vous autour de vous maintenant ?","Combien de temps y passez-vous chaque jour ?"],
    hard: ["Expliquez l'impact sur votre bien-√™tre avec un exemple.","Proposez un changement et justifiez-le."]
  },
  'Supermarket': {
    easy: ["Demandez aussi le prix, s'il vous pla√Æt.","Expliquez votre pr√©f√©rence : marque ou budget ?"],
    hard: ["Comparez deux options selon trois crit√®res.","Proposez un plan B si le produit n'existe pas."]
  },
  'Travel': {
    easy: ["Demandez les horaires et la dur√©e du trajet.","Pr√©voyez un plan B."],
    hard: ["Comparez avec une exp√©rience pr√©c√©dente et tirez une le√ßon.","√âvaluez les co√ªts et b√©n√©fices du choix."]
  },
  'Work': {
    easy: ["Quel √©tait l'objectif principal ?","Quelle a √©t√© la plus grande difficult√© ?"],
    hard: ["Quels indicateurs de succ√®s avez-vous utilis√©s ?","Quelle am√©lioration proposeriez-vous et pourquoi ?"]
  },
  'Small talk': {
    easy: ["Posez une question ouverte pour continuer.","Ajoutez un d√©tail personnel."],
    hard: ["Nuancez avec un contre-exemple ou une limite.","Reliez ce sujet √† une tendance plus large."]
  }
};

/* --- Helpers --- */
function levelBand(lvl){ return (lvl==='A1' || lvl==='A2') ? 'easy' : 'hard'; }
function pad2(n){ return ('0'+n).slice(-2); }

/* --- √âtats globaux --- */
var wantListening = false;
var ttsSpeaking   = false;
var manuallyStopped = false;
var heardAnything = false;
var watchdog = null;
var restarting = false;          // √©vite doubles start()
var lastCoach = "Tr√®s bien. Je vous √©coute.";
var cooldownUntil = 0;           // pause courte apr√®s certaines TTS
window.__firstFollowUpDone = false;

/* --- TTS avec auto-resume et garde double-start --- */
function speak(text, rate){
  lastCoach = text;
  var coachText = document.getElementById('coachText');
  if (coachText) coachText.textContent = text;

  try{
    if (window.speechSynthesis) { speechSynthesis.cancel(); }
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    var r = rate || Number(document.getElementById('rate').value) || 1.0;
    if (r < 0.5) r = 0.5; if (r > 2) r = 2;
    u.rate = r;

    u.onstart = function(){ ttsSpeaking = true; };
    u.onend   = function(){
      ttsSpeaking = false;
      if (wantListening && !running && !manuallyStopped) {
        if (!restarting) {
          restarting = true;
          setTimeout(function(){
            try { recognition && recognition.start(); }catch(e){}
            restarting = false;
          }, 120);
        }
      }
    };

    speechSynthesis.speak(u);
  }catch(e){}
}
function repeat(rate){ speak(lastCoach, rate); }

/* --- Pause mic avant TTS (pour que la relance soit entendue) --- */
function pauseMicForTTS(){
  try {
    if (recognition && running) { recognition.stop(); }
  } catch(e) {}
  running = false;
}

/* --- R√©f√©rences UI --- */
var els = {
  level: document.getElementById('level'),
  category: document.getElementById('category'),
  newBtn: document.getElementById('new'),
  say: document.getElementById('say'),
  prompt: document.getElementById('prompt'),
  start: document.getElementById('start'),
  stop: document.getElementById('stop'),
  status: document.getElementById('status'),
  timer: document.getElementById('timer'),
  text: document.getElementById('text'),
  rate: document.getElementById('rate'),
  repeatBtn: document.getElementById('repeat'),
  slowBtn: document.getElementById('slow'),
  coachOn: document.getElementById('coachOn'),
  silence: document.getElementById('silence'),
  coachText: document.getElementById('coachText')
};
var current = { prompt: null };

/* --- Nouveau sujet (TTS + cooldown) --- */
function pick(){
  var lvl = els.level ? els.level.value : 'any';
  var cat = els.category ? els.category.value : 'any';
  var pool = PROMPTS.filter(function(p){
    var okLvl = (lvl==='any' || p.lvl===lvl);
    var okCat = (cat==='any' || p.cat===cat);
    return okLvl && okCat;
  });
  var p = pool.length ? pool[Math.floor(Math.random()*pool.length)] : PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
  current.prompt = p;

  if (els.prompt) els.prompt.textContent = p.t;

  cooldownUntil = Date.now() + 1500; // √©viter relance/prise de son pendant lecture du sujet
  if (els.coachOn && els.coachOn.checked && els.coachText){
    els.coachText.textContent = "Tr√®s bien. J‚Äô√©nonce le sujet, puis je vous √©coute.";
  }
  var rate = Number(els.rate && els.rate.value) || 1.0;
  speak(p.t, rate);
}

/* --- Reconnaissance vocale + coach (silence) --- */
var recognition=null, running=false, t0=0, tick=null, loop=null, lastChange=0, askedRecently=false;
var canSTT = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
if(!canSTT){
  var st = document.getElementById('status');
  if (st) st.textContent='Reconnaissance vocale : indisponible dans ce navigateur';
}

function start(){
  if(!canSTT){ alert('La reconnaissance vocale n‚Äôest pas disponible ici. Essayez Chrome ou Edge.'); return; }
  manuallyStopped = false;
  wantListening = true;
  heardAnything = false;
  window.__firstFollowUpDone = false;  // reset au d√©marrage

  var Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new Rec();
  recognition.lang='fr-FR';
  recognition.interimResults=true;
  recognition.continuous=true;

  if (els.text) els.text.value='';
  lastChange = Date.now();
  askedRecently=false; cooldownUntil = Date.now();

  recognition.onstart=function(){
    running=true;
    var st = document.getElementById('status');
    if (st) st.textContent='Reconnaissance vocale : √©coute en cours‚Ä¶';
  };
  recognition.onerror=function(){
    var st = document.getElementById('status');
    if (st) st.textContent='Reconnaissance vocale : erreur';
  };
  recognition.onend=function(){
    running=false;
    var st = document.getElementById('status');
    if (st) st.textContent='Reconnaissance vocale : arr√™t√©e';
    stopLoop();
    // relance via watchdog si n√©cessaire
  };
  recognition.onresult=function(e){
    var final='', interim='';
    for(var i=e.resultIndex; i<e.results.length; i++){
      var r=e.results[i];
      if(r.isFinal) final+=r[0].transcript+' ';
      else interim+=r[0].transcript;
    }

    /* Ignorer ce que dit la TTS pour ne pas polluer la transcription */
    if (ttsSpeaking) return;

    var lastChunk = (final || interim || '').trim();
    if (lastChunk.split(/\s+/).filter(Boolean).length >= 3) { heardAnything = true; }

    if (final){
      var low = final.toLowerCase();
      if (/(r√©p(√®|e)te|repeat)/.test(low)) repeat(Number(els.rate && els.rate.value));
      if (/(plus lentement|doucement|slow(er)?)/.test(low)) repeat(Math.max(0.6, Number(els.rate && els.rate.value)*0.8 || 0.8));
    }

    var base = (els.text && els.text.dataset && els.text.dataset.base) ? els.text.dataset.base : '';
    if (els.text){
      els.text.value = base + final + '\n' + interim;
      if (Date.now() > cooldownUntil) { lastChange = Date.now(); askedRecently=false; }
    }
  };

  if (els.text){ if (!els.text.dataset) els.text.dataset = {}; els.text.dataset.base=''; }
  try{ recognition.start(); }catch(e){}

  if (els.start) els.start.disabled=true;
  if (els.stop)  els.stop.disabled=false;

  t0=Date.now();
  tick=setInterval(function(){
    var s=Math.floor((Date.now()-t0)/1000);
    var tm = document.getElementById('timer');
    if (tm) tm.textContent = pad2(Math.floor(s/60))+':'+pad2(s%60);
  }, 250);

  startLoop();
  startWatchdog();

  if (els.coachOn && els.coachOn.checked && els.coachText) {
    els.coachText.textContent = "Parfait. Je suis pr√™t quand vous l‚Äô√™tes.";
  }
}

function stop(){
  manuallyStopped = true;
  wantListening = false;
  try{ recognition && recognition.stop(); }catch(e){}
  if (els.start) els.start.disabled=false;
  if (els.stop)  els.stop.disabled=true;
  clearInterval(tick);
  if (els.text){ if (!els.text.dataset) els.text.dataset = {}; els.text.dataset.base = els.text.value; }
  stopLoop();
  stopWatchdog();
  window.__firstFollowUpDone = false;   // reset √† l‚Äôarr√™t
}

/* --- Boucle des relances --- */
function startLoop(){
  stopLoop();
  loop = setInterval(function(){
    if (!(els.coachOn && els.coachOn.checked) || !wantListening) return;
    var now = Date.now();
    // default fallback 10s if field missing/empty
    var silenceVal = Number(els.silence && els.silence.value) || 10;
    if (silenceVal < 3) silenceVal = 3;
    if (silenceVal > 15) silenceVal = 15;
    var silenceMs = silenceVal * 1000;

    if (ttsSpeaking) return; // pas de relance pendant la TTS

    if (!heardAnything && running && (now - lastChange) >= 8000) {
      pauseMicForTTS();
      speak("Je ne vous entends pas encore. Commencez quand vous voulez : une ou deux phrases suffisent.", Number(els.rate && els.rate.value));
      heardAnything = true;
      lastChange = Date.now();
      return;
    }

    if (heardAnything && running && !askedRecently && (now - lastChange) >= silenceMs && now > cooldownUntil){
      var lvl = (current && current.prompt && current.prompt.lvl) ? current.prompt.lvl : (els.level ? els.level.value : 'B1');
      var cat = (current && current.prompt && current.prompt.cat) ? current.prompt.cat : (els.category ? els.category.value : 'Small talk');
      var transcript = (els.text && els.text.value) ? els.text.value : '';
      var q = pickFollowUp(cat || 'Small talk', lvl || 'B1', transcript);

      // Pause mic so TTS is audible; auto-resume on TTS end
      pauseMicForTTS();

      if (!window.__firstFollowUpDone) {
        window.__firstFollowUpDone = true;
        setTimeout(function(){ speak(q, Number(els.rate && els.rate.value)); }, 800);
      } else {
        speak(q, Number(els.rate && els.rate.value));
      }

      askedRecently = true;
      // slightly longer cooldown so TTS doesn't affect silence timer
      cooldownUntil = now + 1800;
    }
  }, 400);
}
function stopLoop(){ if (loop){ clearInterval(loop); loop=null; } }

/* --- Watchdog : relance auto si l‚Äô√©coute saute (Brave/Android) --- */
function startWatchdog(){
  stopWatchdog();
  watchdog = setInterval(function(){
    if (wantListening && !running && !ttsSpeaking && !manuallyStopped){
      if (!restarting) {
        restarting = true;
        setTimeout(function(){
          try { recognition && recognition.start(); }catch(e){}
          restarting = false;
        }, 120);
      }
    }
  }, 1000);
}
function stopWatchdog(){ if (watchdog){ clearInterval(watchdog); watchdog=null; } }

/* --- G√©n√©ration de relance --- */
function pickFollowUp(category, lvl, transcript){
  var lines = (transcript || '').split(/\n/);
  var last = lines.length ? lines[lines.length-1] : '';
  var num = last.match(/\b(\d{1,2})(?:[:h](\d{2}))?\b/);
  var place = last.match(/\b(paris|lyon|marseille|barcelone|madrid|rome)\b/i);
  if (num) return "Vous avez mentionn√© ¬´ " + num[0] + " ¬ª. Pouvez-vous pr√©ciser pourquoi ce chiffre est important ?";
  if (place) return "Parlez un peu plus de " + place[0] + " : quel quartier, quelles impressions ?";
  var band = levelBand(lvl || 'B1');
  var bankCat = (TEMPLATES[category] && TEMPLATES[category][band]) ? TEMPLATES[category][band] : [];
  var bankGen = TEMPLATES.generic[band];
  var bank = bankCat.concat(bankGen);
  return bank[Math.floor(Math.random()*bank.length)] || "Pouvez-vous d√©velopper un peu ?";
}

/* --- Actions UI --- */
function ttsPrompt(){
  var txt = (els.prompt && els.prompt.textContent) ? els.prompt.textContent.trim() : '';
  if (!txt) return;
  pauseMicForTTS();
  speak(txt, Number(els.rate && els.rate.value) || 1.0);
}

/* --- √âv√©nements --- */
if (els.newBtn)  els.newBtn.addEventListener('click', pick);
if (els.say)     els.say.addEventListener('click', ttsPrompt);
if (els.start)   els.start.addEventListener('click', start);
if (els.stop)    els.stop.addEventListener('click', stop);
if (els.repeatBtn) els.repeatBtn.addEventListener('click', function(){ repeat(Number(els.rate && els.rate.value)); });
if (els.slowBtn)   els.slowBtn.addEventListener('click', function(){ repeat(Math.max(0.6, Number(els.rate && els.rate.value)*0.8 || 0.8)); });

document.addEventListener('keydown', function(e){
  if(e && e.key && e.key.toLowerCase()==='r'){ e.preventDefault(); pick(); }
  if(e && e.code==='Space'){ e.preventDefault(); (els.stop && els.stop.disabled ? start() : stop()); }
});

/* --- Service Worker --- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('./sw.js').catch(function(){});
  });
}
</script>
</body>
</html>
