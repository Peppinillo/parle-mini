<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0b1020" />
<link rel="manifest" href="manifest.webmanifest" />
<title>Parle+ Mini</title>
<style>
  :root{--bg:#0b1020;--card:#141a2e;--line:#1e2746;--text:#e8eefc;--muted:#9fb3d9;--accent:#7aa2ff}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#0b1020,#10152a);color:var(--text)}
  .wrap{max-width:840px;margin:32px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 8px} p{margin:0 0 14px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px 14px 12px;box-shadow:0 8px 22px rgba(0,0,0,.25);margin-bottom:14px}
  label{font-size:12px;color:var(--muted)} select,button,textarea,input[type='number'],input[type='range']{border-radius:12px;border:1px solid var(--line);background:#0e1430;color:var(--text)}
  select,button{padding:10px 12px;font-weight:600} button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#3f67ff,#2a4de7);border-color:#3a56d9}
  button.ghost{background:transparent}
  .prompt{font-size:18px;line-height:1.4;border:1px dashed var(--line);border-radius:14px;padding:12px;background:#0b1226;margin:8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  textarea{width:100%;min-height:130px;padding:12px;resize:vertical}
  .hint{color:var(--muted);font-size:12px}
  .coach{padding:10px;border-radius:12px;background:#0b1226;border:1px solid #25305a}
  .coach b{color:#cfe0ff}
  .q{margin:6px 0 0 0}
  .spacer{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Parle+ Mini</h1>
  <p>Ultra-simple French speaking practice with a light <b>Coach mode</b>. Start once, speak freely; the coach asks follow-ups automatically after short silences.</p>

  <div class="card">
    <div class="row">
      <label>Level</label>
      <select id="level">
        <option value="any">Any</option>
        <option>A1</option><option>A2</option><option>B1</option><option>B2</option><option>C1</option>
      </select>
      <label>Category</label>
      <select id="category">
        <option value="any">Any</option>
        <option>At home</option><option>Supermarket</option><option>Travel</option>
        <option>Work</option><option>Small talk</option>
      </select>
      <button id="new" class="primary">New prompt (R)</button>
      <button id="say" class="ghost">üîä Read aloud</button>
      <span class="hint">Tip: R = new prompt</span>
    </div>
    <div id="prompt" class="prompt">Click ‚ÄúNew prompt‚Äù to start.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="start" class="primary">Start (Space)</button>
      <button id="stop" class="ghost" disabled>Stop</button>
      <span class="hint" id="status">STT: idle</span>
      <span class="hint" id="timer">00:00</span>
      <div class="spacer"></div>
      <label class="hint">Voice speed</label>
      <input type="range" id="rate" min="0.7" max="1.3" step="0.05" value="1.0" style="width:160px">
      <button id="repeat" class="ghost">‚Üª Repeat</button>
      <button id="slow" class="ghost">üê¢ Slow repeat</button>
    </div>
    <label style="display:block;margin-top:8px">Live transcript (fr-FR)</label>
    <textarea id="text" placeholder="Your speech appears here‚Ä¶"></textarea>
    <p class="hint">Voice commands you can say: ‚ÄúR√©p√®te‚Äù, ‚ÄúPlus lentement‚Äù, ‚ÄúParle plus doucement‚Äù.</p>
  </div>

  <div class="card">
    <div class="row">
      <label><input type="checkbox" id="coachOn" checked> Coach mode</label>
      <label>Follow-up after silence (sec)</label>
      <input type="number" id="silence" min="3" max="15" step="1" value="5" style="width:64px">
      <span class="hint">The coach will ask a new question about <b>5s</b> after you stop talking.</span>
    </div>
    <div id="coach" class="coach">
      <div><b>Assistant:</b> <span id="coachText" class="q">J'attends votre r√©ponse‚Ä¶</span></div>
    </div>
  </div>

  <p class="hint">Best support on Chrome/Edge desktop or Android. iOS Safari is limited.</p>
</div>

<script>
  // ---- Prompt bank (now includes B2/C1 examples) ----
  const PROMPTS = [
    {lvl:'A1', cat:'At home', t:"Pr√©sentez-vous en deux phrases."},
    {lvl:'A1', cat:'Supermarket', t:"Commandez une baguette et un caf√© √† emporter."},
    {lvl:'A1', cat:'Travel', t:"Demandez votre chemin vers un mus√©e proche."},
    {lvl:'A2', cat:'At home', t:"D√©crivez votre matin√©e id√©ale en trois phrases."},
    {lvl:'A2', cat:'Work', t:"Expliquez comment vous organisez votre journ√©e de travail."},
    {lvl:'A2', cat:'Travel', t:"R√©servez une chambre d‚Äôh√¥tel pour deux nuits (dates, heure d‚Äôarriv√©e)."},
    {lvl:'B1', cat:'Work', t:"R√©sumez un projet r√©cent: objectif, obstacles, r√©sultats."},
    {lvl:'B1', cat:'Small talk', t:"Donnez votre avis sur le t√©l√©travail: 2 avantages, 2 risques."},
    {lvl:'B1', cat:'Travel', t:"Expliquez un retard de train et demandez une solution."},
    {lvl:'B2', cat:'Small talk', t:"Discutez d‚Äôune tendance tech et son impact quotidien avec un exemple."},
    {lvl:'B2', cat:'Work', t:"D√©crivez un conflit au travail et sa r√©solution, puis tirez une le√ßon."},
    {lvl:'B2', cat:'Travel', t:"Comparez avion et train pour un trajet moyen (co√ªt, temps, confort)."},
    {lvl:'C1', cat:'Work', t:"Exposez votre vision du t√©l√©travail: compromis viables et limites."},
    {lvl:'C1', cat:'Small talk', t:"Argumentez sur l‚ÄôIA g√©n√©rative dans l‚Äô√©ducation avec nuances."},
    {lvl:'C1', cat:'At home', t:"D√©fendez ou critiquez le minimalisme domestique avec un exemple concret."}
  ];

  // ---- Follow-up templates by category and level band ----
  const TEMPLATES = {
    generic: {
      easy: [
        "Pouvez-vous donner un exemple ?",
        "Pourquoi ? Donnez une raison simple.",
        "Qui ? o√π ? quand ?",
        "Ajoutez une phrase de plus, s'il vous pla√Æt."
      ],
      hard: [
        "Nuancez votre r√©ponse avec un contre-argument.",
        "Donnez un exemple pr√©cis et une donn√©e chiffr√©e.",
        "Quelles seraient les cons√©quences √† moyen terme ?",
        "Que proposeriez-vous comme am√©lioration concr√®te ?"
      ]
    },
    'At home': {
      easy: [
        "Quelles trois choses voyez-vous autour de vous maintenant ?",
        "Combien de temps y passez-vous chaque jour ?"
      ],
      hard: [
        "Expliquez l'impact sur votre bien-√™tre avec un exemple.",
        "Proposez un changement et justifiez-le."
      ]
    },
    'Supermarket': {
      easy: [
        "Demandez aussi le prix, s'il vous pla√Æt.",
        "Expliquez votre pr√©f√©rence: marque ou budget ?"
      ],
      hard: [
        "Comparez deux options selon trois crit√®res.",
        "Proposez un plan B si le produit n'existe pas."
      ]
    },
    'Travel': {
      easy: [
        "Demandez les horaires et la dur√©e du trajet.",
        "Pr√©voyez un plan B."
      ],
      hard: [
        "Comparez avec une exp√©rience pr√©c√©dente et tirez une le√ßon.",
        "√âvaluez les co√ªts et b√©n√©fices du choix."
      ]
    },
    'Work': {
      easy: [
        "Quel √©tait l'objectif principal ?",
        "Quelle a √©t√© la difficult√© la plus grande ?"
      ],
      hard: [
        "Quels indicateurs de succ√®s avez-vous utilis√©s ?",
        "Quelle am√©lioration proposeriez-vous et pourquoi ?"
      ]
    },
    'Small talk': {
      easy: [
        "Posez une question ouverte pour continuer.",
        "Ajoutez un d√©tail personnel."
      ],
      hard: [
        "Nuancez avec un contre-exemple ou une limite.",
        "Reliez ce sujet √† une tendance plus large."
      ]
    }
  };

  function levelBand(lvl){
    return ['A1','A2'].includes(lvl) ? 'easy' : 'hard';
  }

  // ---- Speech helpers ----
  let lastCoach = "Tr√®s bien. Je vous √©coute.";
  function speak(text, rate){
    lastCoach = text;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = rate || Number(document.getElementById('rate').value) || 1.0;
      speechSynthesis.speak(u);
    }catch(e){/* ignore */}
    document.getElementById('coachText').textContent = text;
  }
  function repeat(rate){ speak(lastCoach, rate); }

  function pickFollowUp(category, lvl, transcript){
    const last = (transcript || '').split(/\n/).slice(-1)[0] || '';
    const num = last.match(/\b(\d{1,2})(?:[:h](\d{2}))?\b/);
    const place = last.match(/\b(paris|lyon|marseille|barcelone|madrid|rome)\b/i);
    if (num) return `Vous avez mentionn√© "${num[0]}". Pouvez-vous pr√©ciser pourquoi ce chiffre est important ?`;
    if (place) return `Parlez un peu plus de ${place[0]} : quel quartier, quelles impressions ?`;
    const band = levelBand(lvl || 'B1');
    const bankCat = (TEMPLATES[category] && TEMPLATES[category][band]) ? TEMPLATES[category][band] : [];
    const bankGen = TEMPLATES.generic[band];
    const bank = bankCat.concat(bankGen);
    return bank[Math.floor(Math.random()*bank.length)] || "Pouvez-vous d√©velopper un peu ?";
  }

  // ---- UI refs ----
  const els = {
    level: document.getElementById('level'),
    category: document.getElementById('category'),
    newBtn: document.getElementById('new'),
    say: document.getElementById('say'),
    prompt: document.getElementById('prompt'),
    start: document.getElementById('start'),
    stop: document.getElementById('stop'),
    status: document.getElementById('status'),
    timer: document.getElementById('timer'),
    text: document.getElementById('text'),
    rate: document.getElementById('rate'),
    repeat: document.getElementById('repeat'),
    slow: document.getElementById('slow'),
    coachOn: document.getElementById('coachOn'),
    silence: document.getElementById('silence'),
    coachText: document.getElementById('coachText')
  };

  function pick(){
    const lvl = els.level.value, cat = els.category.value;
    const pool = PROMPTS.filter(p=> (lvl==='any'||p.lvl===lvl) && (cat==='any'||p.cat===cat));
    const p = pool[Math.floor(Math.random()*pool.length)] || PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
    current.prompt = p;
    els.prompt.textContent = p.t;
    if (els.coachOn.checked) speak("Tr√®s bien. Allez-y. Je vous √©coute.", Number(els.rate.value));
  }

  // ---- STT & coach loop with silence detection ----
  let recognition=null, running=false, t0=0, tick=null, loop=null, lastChange=0, askedRecently=false, cooldownUntil=0;
  const canSTT = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
  if(!canSTT){ els.status.textContent='STT: unavailable'; }

  function start(){
    if(!canSTT){ alert('Speech recognition not supported in this browser. Try Chrome/Edge.'); return; }
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new Rec();
    recognition.lang='fr-FR'; recognition.interimResults=true; recognition.continuous=true;
    els.text.value='';
    lastChange = Date.now();
    askedRecently=false; cooldownUntil=0;
    recognition.onstart=()=>{ running=true; els.status.textContent='STT: listening‚Ä¶'; };
    recognition.onerror=()=>{ els.status.textContent='STT error'; };
    recognition.onend=()=>{ running=false; els.status.textContent='STT: stopped'; stopLoop(); };
    recognition.onresult=(e)=>{
      let final='', interim='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const r=e.results[i];
        if(r.isFinal) final+=r[0].transcript+' ';
        else interim+=r[0].transcript;
      }
      // voice commands on final
      if (final){
        const low = final.toLowerCase();
        if (/(r√©p(√®|e)te|repeat)/.test(low)) repeat(Number(els.rate.value));
        if (/(plus lentement|doucement|slow(er)?)/.test(low)) repeat(Math.max(0.6, Number(els.rate.value)*0.8));
      }
      els.text.value=(els.text.dataset.base||'')+final+'\n'+interim;
      // Update last change if not during cooldown (avoid picking up TTS)
      if (Date.now() > cooldownUntil) {
        lastChange = Date.now();
        askedRecently=false;
      }
    };
    els.text.dataset.base='';
    recognition.start();
    els.start.disabled=true; els.stop.disabled=false;
    t0=Date.now();
    tick=setInterval(()=>{ const s=Math.floor((Date.now()-t0)/1000); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); els.timer.textContent=m+':'+r; }, 250);
    startLoop();
    if (els.coachOn.checked) speak("Tr√®s bien. Je suis pr√™t quand vous l'√™tes.", Number(els.rate.value));
  }

  function stop(){
    try{ recognition && recognition.stop(); }catch(e){}
    els.start.disabled=false; els.stop.disabled=true;
    clearInterval(tick);
    els.text.dataset.base=els.text.value;
    stopLoop();
  }

  function ttsPrompt(){
    const u=new SpeechSynthesisUtterance(els.prompt.textContent.trim());
    u.lang='fr-FR'; u.rate = Number(els.rate.value) || 1.0; speechSynthesis.speak(u);
  }

  function copy(){ navigator.clipboard.writeText(els.text.value||''); }
  function download(){
    const blob=new Blob([els.text.value||''],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='parle_transcript.txt'; a.click();
  }

  function startLoop(){
    stopLoop();
    loop = setInterval(()=>{
      if (!els.coachOn.checked || !running) return;
      const now = Date.now();
      const silenceMs = Math.max(3000, Math.min(15000, Number(els.silence.value||5)*1000));
      if (!askedRecently && now - lastChange >= silenceMs && now > cooldownUntil){
        const lvl = current.prompt?.lvl || els.level.value || 'B1';
        const cat = current.prompt?.cat || els.category.value || 'Small talk';
        const q = pickFollowUp(cat, lvl, els.text.value);
        speak(q, Number(els.rate.value));
        askedRecently = true;
        cooldownUntil = now + 2500; // don't react to TTS echo for 2.5s
      }
    }, 500);
  }
  function stopLoop(){ if (loop){ clearInterval(loop); loop=null; } }

  // ---- Events ----
  const current = {prompt:null};
  els.newBtn.addEventListener('click', pick);
  els.say.addEventListener('click', ttsPrompt);
  els.start.addEventListener('click', start);
  els.stop.addEventListener('click', stop);
  els.repeat.addEventListener('click', ()=> repeat(Number(els.rate.value)));
  els.slow.addEventListener('click', ()=> repeat(Math.max(0.6, Number(els.rate.value)*0.8)));

  document.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='r'){ e.preventDefault(); pick(); }
    if(e.code==='Space'){ e.preventDefault(); (els.stop.disabled ? start() : stop()); }
  });

  // ---- SW registration ----
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    });
  }
</script>
</body>
</html>
